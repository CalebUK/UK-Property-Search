<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Property Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #0f172a; font-family: 'Inter', sans-serif; }
        #canvas-container { position: relative; width: 100vw; height: 100vh; cursor: grab; }
        .glass-panel {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom Scrollbar for results */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }

        /* Accordion transition */
        .accordion-content { transition: max-height 0.3s ease-out; overflow: hidden; max-height: 0; }
        .accordion-content.open { max-height: 500px; overflow-y: auto; }
        .rotate-180 { transform: rotate(180deg); }

        .house-img {
            background-size: cover; background-position: center; transition: transform 0.3s;
        }
    </style>
</head>
<body>

<!-- SETTINGS BUTTON -->
<button onclick="toggleSettings()" class="absolute top-6 right-6 z-30 text-slate-400 hover:text-white transition p-2 bg-slate-800/50 rounded-full border border-slate-600">
    <i class="fa-solid fa-gear"></i>
</button>

<!-- SETTINGS MODAL -->
<div id="settings-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4">
    <div class="glass-panel w-full max-w-md rounded-2xl p-6 shadow-2xl border border-slate-700">
        <h2 class="text-xl font-bold text-white mb-4">App Settings</h2>
        <div class="mb-4">
            <label class="block text-xs text-slate-400 mb-1">Gemini API Key</label>
            <input type="password" id="api-key-input" placeholder="Paste your API key here" 
                   class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500 text-sm">
            <p class="text-[10px] text-slate-500 mt-1">Stored locally in your browser for the AI Vibe Check.</p>
        </div>
        <div class="flex justify-end gap-2">
            <button onclick="toggleSettings()" class="px-4 py-2 text-slate-300 text-sm hover:text-white">Cancel</button>
            <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-4 py-2 text-sm font-bold transition">Save</button>
        </div>
    </div>
</div>

<!-- SEARCH UI -->
<div class="absolute top-6 left-1/2 transform -translate-x-1/2 z-20 w-[90%] max-w-md">
    <div class="glass-panel rounded-full p-2 flex items-center shadow-2xl border border-slate-600">
        <div class="pl-4 pr-2 text-slate-400"><i class="fa-solid fa-magnifying-glass"></i></div>
        <input type="text" id="postcode-input" placeholder="Enter Postcode (e.g. RG41 5BB)" 
               class="bg-transparent border-none text-white w-full focus:outline-none text-sm placeholder-slate-500 uppercase"
               value="RG41 5BB"
               onkeydown="if(event.key === 'Enter') startSearch()">
        <button onclick="startSearch()" class="bg-blue-600 hover:bg-blue-500 text-white rounded-full px-6 py-2 text-sm font-bold transition">
            Scan
        </button>
    </div>
    <!-- Error/Status Message -->
    <div id="status-msg" class="text-center mt-2 text-xs font-medium text-slate-400 h-4"></div>
</div>

<!-- RESULTS PANEL -->
<div class="absolute top-24 left-4 z-10 w-80 flex flex-col gap-3 pointer-events-none transition-opacity duration-500" id="results-panel">
    
    <!-- Score Card -->
    <div class="glass-panel rounded-xl p-5 text-white pointer-events-auto border-l-4 border-blue-500">
        <div class="flex justify-between items-center mb-2">
            <div>
                <h1 class="text-lg font-bold text-slate-100">Live Score</h1>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest" id="location-label">Winnersh</p>
            </div>
            <div class="relative w-16 h-16 flex items-center justify-center">
                <svg class="w-16 h-16 absolute top-0 left-0" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="40" stroke="#334155" stroke-width="8" fill="transparent"></circle>
                    <circle id="score-circle" cx="50" cy="50" r="40" stroke="#10b981" stroke-width="8" fill="transparent" stroke-dasharray="251.2" stroke-dashoffset="0"></circle>
                </svg>
                <span id="score-text" class="text-xl font-bold">--</span>
            </div>
        </div>

        <!-- AI Feature -->
        <div class="mb-4">
            <button onclick="generateAIVibe()" id="ai-btn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white text-[10px] font-bold py-2 rounded shadow-lg transition flex items-center justify-center gap-2 border border-white/10">
                <i class="fa-solid fa-wand-magic-sparkles"></i> AI Vibe Check
            </button>
            <div id="ai-result" class="hidden mt-2 p-3 bg-slate-900/90 rounded text-[10px] leading-relaxed text-indigo-100 italic border border-indigo-500/30 shadow-inner">
                <!-- AI Text goes here -->
            </div>
        </div>
        
        <!-- Accordion Container -->
        <div class="space-y-1 max-h-[50vh] overflow-y-auto pr-1 custom-scrollbar" id="amenities-list">
            <div class="text-center py-4 text-slate-500 text-xs">Enter a postcode to scan the area...</div>
        </div>
    </div>
</div>

<!-- BOTTOM PANEL: PROPERTY BROWSER -->
<div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 z-10 w-[95%] max-w-3xl pointer-events-none transition-opacity duration-500 opacity-0" id="bottom-ui">
    <div class="glass-panel rounded-xl p-1 pr-4 text-white pointer-events-auto flex items-center gap-4">
        
        <button onclick="prevProperty()" class="w-12 h-full flex items-center justify-center hover:bg-white/5 rounded-l-xl transition group">
            <i class="fa-solid fa-chevron-left text-slate-400 group-hover:text-white"></i>
        </button>
        
        <!-- Image Box -->
        <div class="w-32 h-24 hidden sm:block flex-shrink-0 rounded-lg overflow-hidden relative bg-slate-800">
             <div id="prop-img" class="w-full h-full house-img bg-slate-700"></div>
             <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-t from-black/60 to-transparent"></div>
             <span class="absolute bottom-1 left-2 text-[10px] font-bold text-white"><i class="fa-solid fa-camera mr-1"></i>Simulated</span>
        </div>

        <div class="flex-1 min-w-0 py-2">
            <div class="flex justify-between items-start mb-1">
                <div class="min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                        <span id="prop-status" class="bg-blue-600 text-[9px] font-bold px-1.5 py-0.5 rounded text-white uppercase tracking-wider">For Sale</span>
                        <span id="prop-id" class="text-[10px] text-slate-500">Scanning...</span>
                    </div>
                    <h2 id="prop-address" class="text-lg font-bold leading-none truncate">Searching Market...</h2>
                    <p id="prop-area" class="text-slate-400 text-sm truncate mt-0.5">Wokingham</p>
                </div>
                <div class="text-right ml-2">
                    <div id="prop-price" class="text-xl font-bold text-white tracking-tight">--</div>
                    <div class="text-[10px] text-slate-400">Guide Price</div>
                </div>
            </div>
            
            <div class="flex justify-between items-end mt-2">
                <div class="flex gap-4 text-xs text-slate-300">
                    <span class="flex items-center gap-1"><i class="fa-solid fa-bed text-slate-500"></i> <span id="prop-beds">3+</span></span>
                    <span class="flex items-center gap-1"><i class="fa-solid fa-bath text-slate-500"></i> <span id="prop-baths">2</span></span>
                    <span class="flex items-center gap-1"><i class="fa-solid fa-ruler-combined text-slate-500"></i> <span id="prop-type">Detached</span></span>
                </div>
                <button class="bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold py-1.5 px-3 rounded-lg transition flex items-center gap-2">
                    View Details <i class="fa-solid fa-arrow-up-right-from-square"></i>
                </button>
            </div>
        </div>

        <button onclick="nextProperty()" class="w-12 h-full flex items-center justify-center hover:bg-white/5 rounded-r-xl transition group">
            <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-white"></i>
        </button>
    </div>
</div>

<!-- Canvas -->
<div id="canvas-container">
    <canvas id="mapCanvas"></canvas>
</div>

<script>
    // --- CONFIG & STATE ---
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    
    const prefs = {
        schoolWeight: 8,
        commuteWeight: 6,
        socialWeight: 5
    };

    // State
    let searchCenter = { lat: 0, lon: 0 };
    let properties = [];
    let currentPropIndex = 0;
    let amenities = [];
    let camera = { x: 0, y: 0 };
    let targetCamera = { x: 0, y: 0 };
    
    // API Key Management
    let apiKey = localStorage.getItem('gemini_api_key') || "";

    function toggleSettings() {
        const modal = document.getElementById('settings-modal');
        const input = document.getElementById('api-key-input');
        if(modal.style.display === 'flex') {
            modal.style.display = 'none';
        } else {
            modal.style.display = 'flex';
            input.value = apiKey;
        }
    }

    function saveSettings() {
        const input = document.getElementById('api-key-input');
        apiKey = input.value.trim();
        localStorage.setItem('gemini_api_key', apiKey);
        toggleSettings();
        alert("Settings saved!");
    }

    // --- GEMINI AI INTEGRATION ---
    async function generateAIVibe() {
        if(!apiKey) {
            toggleSettings();
            alert("Please enter a Gemini API Key in settings first.");
            return;
        }
        if(amenities.length === 0) {
            alert("Please scan a postcode first.");
            return;
        }

        const btn = document.getElementById('ai-btn');
        const output = document.getElementById('ai-result');
        
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Analyzing...';
        btn.disabled = true;
        output.classList.remove('hidden');
        output.innerText = "Consulting Gemini AI...";

        const area = document.getElementById('location-label').innerText;
        const score = document.getElementById('score-text').innerText;
        
        const topAmenities = amenities
            .sort((a,b) => a.dist - b.dist)
            .slice(0, 15)
            .map(a => `${a.name} (${a.type})`)
            .join(', ');

        const prompt = `
            You are a savvy UK property expert. The user is considering a move to ${area}.
            
            App Data:
            - Calculated Lifestyle Score: ${score}
            - User Priorities (1-10): Schools (${prefs.schoolWeight}), Commute (${prefs.commuteWeight}), Social (${prefs.socialWeight}).
            - Key Amenities nearby: ${topAmenities}.

            Task: Write a sophisticated, short (max 2 sentences) "Vibe Check" for this location. 
            Focus on what living here actually feels like based on the specific amenities found. 
            Be honest about pros/cons (e.g. if great schools but no pubs, mention it's quiet but family-focused).
        `;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            
            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "AI analysis unavailable.";
            
            output.innerHTML = `<span class="text-purple-300 font-bold">AI Analysis:</span> "${text.trim()}"`;
        } catch (e) {
            console.error(e);
            output.innerText = "Error connecting to AI service. Check your API Key.";
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // --- STATIC DATA LOOKUP ---
    const OFSTED_CACHE = [
        { key: "holt", name: "The Holt School", rating: "Outstanding", type: "Secondary", date: "15 Nov 2023" },
        { key: "st paul", name: "St Paul's Junior", rating: "Outstanding", type: "Primary", date: "12 Mar 2022" },
        { key: "walter", name: "Walter Infant", rating: "Outstanding", type: "Primary", date: "05 Jun 2024" },
        { key: "crispin", name: "St Crispin's", rating: "Good", type: "Secondary", date: "20 Sep 2023" },
        { key: "emmbrook", name: "The Emmbrook School", rating: "Good", type: "Secondary", date: "10 Jan 2024" },
        { key: "keep hatch", name: "Keep Hatch Primary", rating: "Good", type: "Primary", date: "14 Feb 2023" },
        { key: "evendons", name: "Evendons Primary", rating: "Outstanding", type: "Primary", date: "22 Oct 2022" },
        { key: "hawthorns", name: "The Hawthorns Primary", rating: "Good", type: "Primary", date: "08 Dec 2023" }, 
        { key: "winnersh primary", name: "Winnersh Primary", rating: "Good", type: "Primary", date: "18 May 2022" },
        { key: "forest", name: "The Forest School", rating: "Good", type: "Secondary", date: "30 Nov 2023" },
        { key: "west ende", name: "West Ende", rating: "Good", type: "Primary", date: "11 Jul 2023" },
        { key: "wheatfield", name: "Wheatfield Primary", rating: "Good", type: "Primary", date: "2023" },
        { key: "windmill", name: "Windmill Primary", rating: "Good", type: "Primary", date: "2023" },
        { key: "bohunt", name: "Bohunt School", rating: "Good", type: "Secondary", date: "2023" },
        { key: "maiden erlegh", name: "Maiden Erlegh School", rating: "Outstanding", type: "Secondary", date: "2020" },
        { key: "edgbarrow", name: "Edgbarrow School", rating: "Outstanding", type: "Secondary", date: "2023" }
    ];

    const STATION_CONNECTIONS = {
        "Wokingham": ["Waterloo (65m)", "Reading (10m)", "Gatwick (55m)", "Guildford (35m)"],
        "Winnersh": ["Waterloo (60m)", "Reading (10m)", "Richmond (50m)"],
        "Winnersh Triangle": ["Waterloo (58m)", "Reading (6m)"],
        "Earley": ["Waterloo (55m)", "Reading (5m)"],
        "Bracknell": ["Waterloo (55m)", "Reading (20m)"],
        "Crowthorne": ["Reading (15m)", "Gatwick (50m)"],
        "Twyford": ["Paddington (25m)", "Reading (7m)", "Elizabeth Line"]
    };

    const AIRPORTS = [
        { name: "London Heathrow", lat: 51.4700, lon: -0.4543 },
        { name: "London Gatwick", lat: 51.1537, lon: -0.1821 },
        { name: "London Stansted", lat: 51.8860, lon: 0.2389 },
        { name: "London Luton", lat: 51.8763, lon: -0.3717 },
        { name: "Southampton", lat: 50.9515, lon: -1.3568 }
    ];

    const TYPES = {
        SCHOOL_OUTSTANDING: { color: '#22c55e', baseWeight: 40, icon: 'graduation-cap', range: 1500, label: 'Schools' }, 
        SCHOOL_GOOD: { color: '#eab308', baseWeight: 15, icon: 'school', range: 1200, label: 'Schools' },
        TRANSPORT: { color: '#a855f7', baseWeight: 30, icon: 'train', range: 2500, label: 'Transportation' },
        AIRPORT: { color: '#a855f7', baseWeight: 20, icon: 'plane', range: 100000, label: 'Transportation' }, 
        PUB: { color: '#3b82f6', baseWeight: 20, icon: 'beer-mug-empty', range: 1200, label: 'Pubs' },
        CAFE: { color: '#f97316', baseWeight: 15, icon: 'mug-hot', range: 1000, label: 'Cafes' },
        RESTAURANT: { color: '#ef4444', baseWeight: 15, icon: 'utensils', range: 1500, label: 'Restaurants' } 
    };

    // --- PROPERTY GENERATION (MOCK SCRUBBER) ---
    function generateMockProperties(lat, lon, areaName) {
        const mockProps = [];
        const streets = ["Woodward Close", "Reading Road", "Robin Hood Lane", "King Street", "Forest Road", "Church Lane", "Barkham Ride"];
        
        for (let i = 0; i < 5; i++) {
            const latOffset = (Math.random() - 0.5) * 0.008; 
            const lonOffset = (Math.random() - 0.5) * 0.012;
            const price = 500000 + Math.floor(Math.random() * 50) * 10000;
            const beds = 3 + Math.floor(Math.random() * 2); 
            const street = streets[Math.floor(Math.random() * streets.length)];
            const isDetached = Math.random() > 0.3; 

            mockProps.push({
                id: 100 + i,
                address: street,
                area: areaName || "Wokingham Area",
                price: price,
                beds: beds,
                baths: 2,
                type: isDetached ? "Detached" : "Semi-Detached",
                lat: lat + latOffset,
                lon: lon + lonOffset,
                x: 0, y: 0, 
                color: ["#475569", "#334155", "#1e293b", "#0f172a"][i % 4]
            });
        }
        return mockProps;
    }

    // --- API 1: POSTCODES.IO ---
    async function getCoordinates(postcode) {
        try {
            const response = await fetch(`https://api.postcodes.io/postcodes/${postcode}`);
            const data = await response.json();
            if (data.status === 200) {
                return { lat: data.result.latitude, lon: data.result.longitude, area: data.result.admin_ward };
            } else { throw new Error("Invalid Postcode"); }
        } catch (e) { return null; }
    }

    // --- API 2: OVERPASS API (OSM) ---
    async function getLiveAmenities(lat, lon) {
        const query = `
            [out:json];
            (
              node["amenity"="pub"](around:1500, ${lat}, ${lon});
              node["amenity"="cafe"](around:1200, ${lat}, ${lon});
              node["amenity"="restaurant"](around:1500, ${lat}, ${lon});
              node["railway"="station"](around:3000, ${lat}, ${lon});
              node["amenity"="school"](around:2500, ${lat}, ${lon});
              way["amenity"="school"](around:2500, ${lat}, ${lon}); 
            );
            out center;
        `;
        const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            
            return data.elements.map(el => {
                const lat = el.lat || el.center?.lat;
                const lon = el.lon || el.center?.lon;
                const tags = el.tags || {};
                
                let type = 'UNKNOWN';
                if (tags.railway === 'station') type = 'TRANSPORT';
                else if (tags.amenity === 'pub') type = 'PUB';
                else if (tags.amenity === 'cafe') type = 'CAFE';
                else if (tags.amenity === 'restaurant') type = 'RESTAURANT';
                else if (tags.amenity === 'school') type = 'SCHOOL';

                return {
                    id: el.id,
                    name: tags.name || "Unnamed",
                    type: type,
                    lat: lat,
                    lon: lon,
                    rawTags: tags
                };
            }).filter(item => item.lat && item.lon && item.name !== "Unnamed");
        } catch (e) {
            console.error("OSM Error", e);
            return [];
        }
    }

    // --- MATCHING LOGIC ---
    function augmentSchoolData(osmSchool) {
        const lowerName = osmSchool.name.toLowerCase();
        const match = OFSTED_CACHE.find(entry => lowerName.includes(entry.key));
        
        if (match) {
            return {
                ...osmSchool,
                rating: match.rating,
                schoolType: match.type,
                date: match.date,
                category: match.rating === 'Outstanding' ? 'SCHOOL_OUTSTANDING' : 'SCHOOL_GOOD'
            };
        } else {
            let estimatedType = "School";
            if (lowerName.includes('primary') || lowerName.includes('infant') || lowerName.includes('junior')) estimatedType = "Primary";
            else if (lowerName.includes('secondary') || lowerName.includes('college') || lowerName.includes('high')) estimatedType = "Secondary";
            
            return {
                ...osmSchool,
                rating: "Unknown",
                schoolType: estimatedType,
                date: "N/A",
                category: 'SCHOOL_GOOD' 
            };
        }
    }

    // --- MAIN LOGIC ---
    async function startSearch() {
        const input = document.getElementById('postcode-input');
        const status = document.getElementById('status-msg');
        const postcode = input.value.trim();
        
        if(postcode.length < 5) { status.innerText = "Please enter a full postcode"; return; }

        status.innerHTML = '<div class="loading-spinner inline-block align-middle mr-2"></div> Scanning area...';
        
        amenities = [];
        properties = [];
        document.getElementById('ai-result').classList.add('hidden');
        
        const loc = await getCoordinates(postcode);
        if (!loc) { status.innerText = "Postcode not found."; return; }

        searchCenter.lat = loc.lat;
        searchCenter.lon = loc.lon;
        document.getElementById('location-label').innerText = loc.area || "Unknown Area";

        const liveRaw = await getLiveAmenities(searchCenter.lat, searchCenter.lon);
        
        amenities = liveRaw.map(el => {
            if (el.type === 'SCHOOL') {
                const aug = augmentSchoolData(el);
                el = { ...el, ...aug, type: aug.category };
            }
            return el;
        });

        let nearestAirport = null;
        let minAirportDist = Infinity;
        AIRPORTS.forEach(ap => {
            const dist = getDistanceFromLatLonInKm(searchCenter.lat, searchCenter.lon, ap.lat, ap.lon) * 1000;
            if(dist < minAirportDist) {
                minAirportDist = dist;
                nearestAirport = { name: ap.name, type: 'AIRPORT', lat: ap.lat, lon: ap.lon };
            }
        });
        if(nearestAirport) amenities.push(nearestAirport);

        properties = generateMockProperties(searchCenter.lat, searchCenter.lon, loc.area);
        
        status.innerText = `Found ${properties.length} properties & ${amenities.length} amenities.`;
        document.getElementById('bottom-ui').style.opacity = '1';
        
        loadProperty(0);
    }

    function loadProperty(index) {
        if(index < 0) index = properties.length - 1;
        if(index >= properties.length) index = 0;
        currentPropIndex = index;
        const prop = properties[index];

        document.getElementById('prop-id').innerText = `#${index+1} of ${properties.length}`;
        document.getElementById('prop-address').innerText = prop.address;
        document.getElementById('prop-area').innerText = prop.area;
        document.getElementById('prop-price').innerText = 'Â£' + (prop.price/1000).toFixed(0) + 'k';
        document.getElementById('prop-beds').innerText = prop.beds;
        document.getElementById('prop-type').innerText = prop.type;
        document.getElementById('prop-img').style.backgroundColor = prop.color;

        amenities.forEach(a => {
            a.dist = getDistanceFromLatLonInKm(prop.lat, prop.lon, a.lat, a.lon) * 1000;
        });

        updateMapProjection(prop);
        calculateScore();
        draw();
    }

    function prevProperty() { loadProperty(currentPropIndex - 1); }
    function nextProperty() { loadProperty(currentPropIndex + 1); }

    function updateMapProjection(centerProp) {
        amenities.forEach(a => {
            const dLat = a.lat - centerProp.lat;
            const dLon = a.lon - centerProp.lon;
            const metersY = dLat * 111320; 
            const metersX = dLon * (40075000 * Math.cos(centerProp.lat * Math.PI / 180) / 360);
            a.x = metersX; 
            a.y = -metersY;
        });

        properties.forEach(p => {
            const dLat = p.lat - centerProp.lat;
            const dLon = p.lon - centerProp.lon;
            const metersY = dLat * 111320; 
            const metersX = dLon * (40075000 * Math.cos(centerProp.lat * Math.PI / 180) / 360);
            p.x = metersX; 
            p.y = -metersY;
        });
    }

    // --- SCORING & UI ---
    function toggleDetails(id) {
        const el = document.getElementById(id);
        if(el) el.classList.toggle('hidden');
    }

    function toggleCategory(id) {
        const content = document.getElementById(id);
        const icon = document.getElementById(`icon-${id}`);
        if(content.classList.contains('open')) {
            content.classList.remove('open');
            icon.classList.remove('rotate-180');
        } else {
            content.classList.add('open');
            icon.classList.add('rotate-180');
        }
    }

    function getStationConnections(stationName) {
        for (const [key, val] of Object.entries(STATION_CONNECTIONS)) {
            if (stationName.includes(key) || key.includes(stationName)) return val;
        }
        return null;
    }

    function calculateScore() {
        let totalPoints = 0;
        let validMatches = [];

        amenities.forEach(a => {
            const typeConfig = TYPES[a.type];
            if (!typeConfig) return; 

            let points = 0;
            let userMultiplier = 1;
            
            if(a.type.includes('SCHOOL')) userMultiplier = prefs.schoolWeight / 5;
            else if(a.type === 'TRANSPORT' || a.type === 'AIRPORT') userMultiplier = prefs.commuteWeight / 5;
            else userMultiplier = prefs.socialWeight / 5; 

            if (a.type === 'AIRPORT') {
                if (a.dist < 50000) points = typeConfig.baseWeight * userMultiplier;
                else points = Math.round(typeConfig.baseWeight * userMultiplier * (1 - (a.dist - 50000)/50000));
                if (points > 0) validMatches.push({ ...a, score: points, ...typeConfig });
                totalPoints += points;
            } 
            else if (a.dist < typeConfig.range) {
                const score = Math.round(typeConfig.baseWeight * userMultiplier * (1 - a.dist/typeConfig.range));
                if (score > 0) {
                    totalPoints += score;
                    validMatches.push({ ...a, score, ...typeConfig });
                }
            }
        });

        const finalScore = Math.min(100, totalPoints);
        
        document.getElementById('score-text').innerText = finalScore + '%';
        const circle = document.getElementById('score-circle');
        const offset = (2 * Math.PI * 40) * (1 - finalScore / 100);
        circle.style.strokeDashoffset = offset;
        
        if(finalScore > 75) circle.style.stroke = '#22c55e';
        else if(finalScore > 45) circle.style.stroke = '#eab308';
        else circle.style.stroke = '#ef4444';

        const groups = { 'Schools': [], 'Transportation': [], 'Pubs': [], 'Cafes': [], 'Restaurants': [] };
        validMatches.sort((a,b) => a.dist - b.dist);
        validMatches.forEach(m => { if(m.label && groups[m.label]) groups[m.label].push(m); });

        const list = document.getElementById('amenities-list');
        list.innerHTML = '';
        let hasItems = false;
        
        const getCatIcon = (label) => {
            if(label === 'Schools') return { icon: 'graduation-cap', color: 'text-green-400' };
            if(label === 'Transportation') return { icon: 'train', color: 'text-purple-400' };
            if(label === 'Pubs') return { icon: 'beer-mug-empty', color: 'text-blue-400' };
            if(label === 'Cafes') return { icon: 'mug-hot', color: 'text-orange-400' };
            if(label === 'Restaurants') return { icon: 'utensils', color: 'text-red-400' };
            return { icon: 'circle', color: 'text-slate-400' };
        }

        for (const [label, items] of Object.entries(groups)) {
            if (items.length === 0) continue;
            hasItems = true;
            const catId = `cat-${label.toLowerCase()}`;
            const { icon, color } = getCatIcon(label);

            const itemsHtml = items.map((m, index) => {
                let extraHtml = '';
                let buttonHtml = '';
                const detailId = `detail-${label}-${index}`;

                if (m.type === 'TRANSPORT') {
                    const conns = getStationConnections(m.name);
                    if (conns) {
                        buttonHtml = `<button onclick="toggleDetails('${detailId}')" class="ml-2 text-[9px] text-blue-300 hover:text-white border border-blue-500/50 px-1 rounded transition flex-shrink-0"><i class="fa-solid fa-route mr-1"></i></button>`;
                        extraHtml = `<div id="${detailId}" class="hidden mt-1 ml-6 p-2 bg-slate-900/80 rounded text-[10px] text-slate-300 border-l-2 border-purple-500"><div class="font-bold mb-1 text-purple-400">Direct trains to:</div><ul class="list-disc pl-3 space-y-0.5">${conns.map(c => `<li>${c}</li>`).join('')}</ul></div>`;
                    }
                }
                else if (m.type.startsWith('SCHOOL')) {
                    const isCached = m.rating !== "Unknown";
                    buttonHtml = `<button onclick="toggleDetails('${detailId}')" class="ml-2 text-[9px] text-blue-300 hover:text-white border border-blue-500/50 px-1 rounded transition flex-shrink-0"><i class="fa-solid fa-circle-info mr-1"></i></button>`;
                    const borderColor = m.rating === 'Outstanding' ? 'border-green-500' : (m.rating === 'Unknown' ? 'border-slate-500' : 'border-yellow-500');
                    const ratingClass = m.rating === 'Outstanding' ? 'text-green-400' : (m.rating === 'Unknown' ? 'text-slate-400' : 'text-yellow-400');
                    extraHtml = `<div id="${detailId}" class="hidden mt-1 ml-6 p-2 bg-slate-900/80 rounded text-[10px] text-slate-300 border-l-2 ${borderColor}"><div class="grid grid-cols-2 gap-1 mb-1"><span class="text-slate-400">Type:</span> <span class="font-semibold text-white">${m.schoolType}</span>${isCached ? `<span class="text-slate-400">Date:</span> <span class="font-semibold text-white">${m.date}</span>` : ''}</div><div class="text-slate-400">Rating: <span class="font-bold ${ratingClass}">${m.rating}</span></div></div>`;
                }

                let distStr = Math.round(m.dist) + "m";
                if (m.dist >= 1000) distStr = (m.dist/1000).toFixed(1) + "km";

                return `<div class="mb-2"><div class="flex items-center justify-between text-xs"><div class="flex items-center min-w-0 flex-1"><div class="w-4 text-center flex-shrink-0 mr-2 text-[8px] text-slate-500"><i class="fa-solid fa-${m.icon}"></i></div><div class="truncate max-w-[140px]" title="${m.name}">${m.name}</div>${buttonHtml}</div><div class="flex items-center gap-2 flex-shrink-0"><span class="text-slate-500 text-[10px]">${distStr}</span><span class="font-bold text-green-400 text-[10px]">+${m.score}</span></div></div>${extraHtml}</div>`;
            }).join('');

            list.innerHTML += `<div class="border-b border-slate-700/50"><button onclick="toggleCategory('${catId}')" class="w-full flex justify-between items-center py-3 px-1 text-xs font-bold text-slate-200 hover:bg-white/5 transition rounded"><div class="flex items-center gap-2"><i class="fa-solid fa-${icon} w-4 ${color}"></i><span>${label}</span><span class="bg-slate-700 text-slate-300 text-[9px] px-1.5 py-0.5 rounded-full">${items.length}</span></div><i class="fa-solid fa-chevron-down text-slate-500 transition-transform duration-300" id="icon-${catId}"></i></button><div id="${catId}" class="accordion-content px-2 bg-black/10 rounded-b"><div class="py-2 space-y-1">${itemsHtml}</div></div></div>`;
        }
        if (!hasItems) list.innerHTML = '<div class="text-center py-4 text-slate-500 text-xs">Nothing within range.</div>';
    }

    function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
        var R = 6371; 
        var dLat = deg2rad(lat2-lat1); 
        var dLon = deg2rad(lon2-lon1); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        var d = R * c; 
        return d;
    }
    function deg2rad(deg) { return deg * (Math.PI/180); }

    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
    }
    window.addEventListener('resize', resize);
    resize();

    function draw() {
        ctx.fillStyle = '#0f172a';
        ctx.fillRect(0, 0, width, height);
        
        const cx = width / 2;
        const cy = height / 2;

        ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 1;
        const scale = 0.2; 
        
        [500, 1000, 1500].forEach((r, i) => {
            ctx.beginPath();
            ctx.arc(cx, cy, r * scale, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(255,255,255,0.05)';
            ctx.stroke();
            ctx.fillStyle = 'rgba(255,255,255,0.1)';
            ctx.fillText(`${r}m`, cx + 5, cy - (r * scale) + 12);
        });

        amenities.forEach(a => {
            if (a.type === 'AIRPORT') return;
            const screenX = cx + (a.x * scale);
            const screenY = cy + (a.y * scale);
            const typeConfig = TYPES[a.type] || { color: '#64748b' };

            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.lineTo(screenX, screenY);
            ctx.strokeStyle = (a.score > 0) ? typeConfig.color : '#334155';
            ctx.lineWidth = (a.score > 0) ? 2 : 1;
            ctx.globalAlpha = (a.score > 0) ? 0.6 : 0.2;
            ctx.stroke();
            ctx.globalAlpha = 1.0;

            ctx.beginPath();
            ctx.arc(screenX, screenY, 4, 0, Math.PI * 2);
            ctx.fillStyle = (a.score > 0) ? typeConfig.color : '#475569';
            ctx.fill();

            if (a.score > 0) {
                ctx.fillStyle = '#cbd5e1';
                ctx.font = '10px Inter';
                ctx.textAlign = 'center';
                ctx.fillText(a.name.substring(0, 15) + (a.name.length>15?'...':''), screenX, screenY + 15);
            }
        });

        properties.forEach((p, idx) => {
            const screenX = cx + (p.x * scale);
            const screenY = cy + (p.y * scale);
            
            if(idx === currentPropIndex) {
                ctx.beginPath(); ctx.arc(screenX, screenY, 8, 0, Math.PI * 2); ctx.fillStyle = '#fff'; ctx.fill();
                ctx.beginPath(); ctx.arc(screenX, screenY, 20, 0, Math.PI * 2); ctx.fillStyle = 'rgba(59, 130, 246, 0.3)'; ctx.fill();
            } else {
                ctx.beginPath(); ctx.arc(screenX, screenY, 5, 0, Math.PI * 2); ctx.fillStyle = '#64748b'; ctx.fill();
            }
        });

        requestAnimationFrame(draw);
    }
    
    draw();

</script>
</body>
</html>